
import os
import re

FEATURES_DIR = "/Users/wuulong/github/bmad-pa/events/notes/wuulong-notes-blog/static/walkgis_prj/features"
FILE_PATTERN = re.compile(r"20260111_ia_central_canals_(\d+)_+(.*)\.md")

# Data dictionary based on research
DATA = {
    "00": { # 八堡一圳
        "desc": "八堡一圳是臺灣最古老且規模最大的埤圳之一，這條「彰化母親河」自清康熙58年（1719年）完工以來，已滋養彰化平原三百年。由施世榜籌建，並得傳奇人物「林先生」傳授「籠仔篙」工法，成功引濁水溪入圳。",
        "history": "康熙48年（1709）施世榜著手興建，歷時十年，因取水困難幾度失敗。後遇一老翁（林先生）傳授以竹編圓錐「籠仔篙」攔水導流，終於成功。日治時期與十五庄圳（八堡二圳）合併。",
        "features": "古老工法（籠仔篙）、跑水節文化。",
        "info": "- **長度**: 幹線約33公里\n- **灌溉面積**: 約1.2萬公頃\n- **取水口**: 二水鄉鼻仔頭"
    },
    "01": { # 用水管制中心
        "desc": "位於彰化縣二水鄉的八堡圳用水管制中心，是調度彰化平原農業用水的大腦。鄰近林先生廟與八堡圳公園。",
        "history": "隨著灌溉系統現代化，為精準調控八堡一、二圳水量而設。",
        "features": "設有現代化水門遙控系統，旁有紀念林先生的廟宇。",
        "info": "- **位置**: 彰化縣二水鄉源泉村\n- **鄰近**: 八堡圳分水門"
    },
    "02": { # 葫蘆墩圳舊進水口 (同源圳)
        "desc": "此處應為「同源圳舊進水口」相關遺址，見證了濁水溪水源開發的早期歷史。同源圳亦是引濁水溪灌溉名間鄉的重要水利設施。",
         "history": "早期先民為開墾名間、集集一帶河階地所建。",
        "features": "歷史水利遺跡，現存有紀念碑。",
        "info": "- **位置**: 名間鄉濁水溪畔"
    },
    "03": { # 東西三圳
        "desc": "東西三圳是彰化平原重要的灌溉支脈，流經員林市區等地，串連起城鎮與農田的水綠網絡。",
        "history": "屬八堡圳水系之一環，隨著都市發展，部分河段已成為市區內的景觀河道。",
        "features": "員林河濱路段設有步道，是居民休閒散步的好去處。",
        "info": "- **流經**: 員林市、大村鄉等"
    },
    "04": { # 義和共同制水埧
        "desc": "義和共同制水閘是八堡圳系的重要水利節點，負責調節分配下游灌區用水。",
        "history": "日治時期至戰後持續更新改建，確保供水穩定。",
        "features": "具備水利調節與防洪功能。",
        "info": "- **功能**: 分水與制水"
    },
    "05": { # 斗六大圳
        "desc": "斗六大圳主要引清水溪與濁水溪水源，是戰後台灣第一條由國人自力設計與興建的大型水利工程，灌溉雲林內陸地區。",
        "history": "日治時期即有規劃，但受戰爭影響停擺。戰後於1947年由國民政府重啟，克服通膨與技術困難，於1957年完工。最著名工程為跨越清水溪的倒虹吸管。",
        "features": "戰後初期代表性水利工程，解決了斗六丘陵地的缺水問題。",
        "info": "- **完工年**: 1957年\n- **灌溉面積**: 約6,000公頃"
    },
    "06": { # 水圳綠道起點
        "desc": "水圳綠道是沿著嘉南大圳濁幹線與北幹線建置的國家級自行車道。此處為起點，位於雲林農田水利文物館旁。",
        "history": "為推廣水利文化與低碳旅遊，農水署將百年大圳巡水路轉型為綠蔭廊道。",
        "features": "全長88公里，串聯雲林至台南，沿途落羽松美景著名。",
        "info": "- **長度**: 88公里 (總長)\n- **起點**: 林內鄉"
    },
    "07": { # 林內二號進水口
        "desc": "林內二號進水口利用集集攔河堰放流之餘水，再次引入濁幹線，充分利用水資源。",
        "history": "配合集集共同引水計畫後的調度設施。",
        "features": "高效的水資源再利用設施。",
        "info": "- **位置**: 雲林縣林內鄉"
    },
    "08": { # 林內分水工 (八卦池)
        "desc": "著名的「八卦池」，正式名稱為林內沉砂池與分水工。其獨特的八角形設計能讓水流緩慢迴旋，沉澱泥沙並精準分水。",
        "history": "為解決濁水溪高含沙問題而設計。",
        "features": "全台首座八角形分水工，具幾何美感，周邊種植落羽松，冬季景色迷人。",
        "info": "- **功能**: 沉砂、分水\n- **特徵**: 八角形結構"
    },
    "09": { # 後庄埤親水公園
        "desc": "原為灌溉用的後庄埤，經整治後轉型為親水公園。園區內的「天空之島」造景與蜿蜒水岸，成為斗六市民的新休憩點。",
        "history": "早期為單純農用埤塘，隨都市發展曾一度荒廢，2024年完成改造。",
        "features": "兼具灌溉、滯洪與觀光休閒功能。",
        "info": "- **位置**: 雲林縣斗六市"
    },
    "10": { # 新頂埤頭線大排
        "desc": "雲林農田水利系統的重要排水路之一，肩負著區域排水與可能的灌溉餘水回收功能。",
        "history": "屬嘉南大圳濁幹線排水系統。",
        "features": "典型的平原農業排水景觀。",
        "info": "- **類別**: 區域排水"
    },
    "11": { # 濁幹線調蓄池
        "desc": "為解決濁水溪枯水期缺水及高濁度問題，於濁幹線沿線設置的調蓄池（人工湖），夜間儲水、日間供水。",
        "history": "近年來推動的現代化水利設施，提升用水韌性。",
        "features": "具備沉砂、蓄水功能，水域寬廣平靜。",
        "info": "- **功能**: 蓄豐濟枯"
    },
    "12": { # 北圳步道
        "desc": "位於國姓鄉北港村的北圳步道，沿著北圳蜿蜒於山腳下。步道旁有古樸的水車與知名的糯米橋。",
        "history": "北圳建於日治時期（1937年），由客家先民開鑿。",
        "features": "結合客家聚落、水車文化與田園風光。",
        "info": "- **位置**: 南投縣國姓鄉"
    },
    "13": { # 阿罩霧圳幹線
        "desc": "阿罩霧圳引烏溪水源灌溉霧峰（古稱阿罩霧）地區，孕育了知名的「霧峰香米」。",
        "history": "清道光年間（1838年）由霧峰林家林定邦家族開鑿，數百年來皆為霧峰農業命脈。",
        "features": "流經霧峰林家花園周邊系統，極具歷史價值。",
        "info": "- **灌溉作物**: 霧峰香米"
    },
    "14": { # 鳳雛生態步道
        "desc": "位於埔里水頭里的生態步道，沿著南烘圳支流而行。因鄰近「鳳雛洞」傳說而得名。",
        "history": "921地震後社區重建的成果，結合生態復育（螢火蟲、蝴蝶）。",
        "features": "生態豐富，有「哲學步道」之稱。",
        "info": "- **位置**: 南投縣埔里鎮"
    },
    "15": { # 土城工作站
        "desc": "南投管理處土城工作站，設有「農田水利教育園區」，展示各種水利文物與模型。",
        "history": "為推廣農田水利教育而設立。",
        "features": "戶外展示有龍骨水車等傳統農具，是戶外教學熱點。",
        "info": "- **位置**: 南投縣草屯鎮"
    },
    "16": { # 頭社水庫
        "desc": "台灣本島最小的水庫，藏身於日月潭旁。匯集大舌滿溪水源，灌溉頭社盆地。",
        "history": "1979年由林洋港倡議興建，主要為解決頭社盆地灌溉與防洪問題。",
        "features": "迷你幽靜，晨霧繚繞。周邊為著名的「活盆地」泥炭土地質。",
        "info": "- **完工年**: 1979年\n- **蓄水量**: 約23萬噸"
    },
    "17": { # 頭社水庫生態步道
        "desc": "環繞頭社水庫的木棧道與山龍坑吊橋，路程短而平緩，野薑花季時香氣襲人。",
        "history": "近年轉型觀光遊憩後增設的設施。",
        "features": "每年金針花季與螢火蟲季是熱門造訪時機。",
        "info": "- **步道長度**: 環湖約1-2公里"
    }
}

def update_file(filepath, idx, name):
    key = str(idx).zfill(2)
    if key not in DATA:
        print(f"No data for {key} ({name})")
        return

    info = DATA[key]
    
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    # Create new content sections
    new_sections = f"""## 簡介
{info['desc']}

## 歷史與故事
{info['history']}

## 特色
{info['features']}

## 基本資訊
{info['info']}

## 相關連結"""
    
    # Replace the placeholder
    new_content = content.replace("## 簡介\n(待補充詳細資料)\n\n## 相關連結", new_sections)
    
    # If replacement failed (maybe context changed), try regex replace or just append if check fails
    if new_content == content:
         # Fallback search
         new_content = re.sub(r"## 簡介\n\(待補充詳細資料\)", f"## 簡介\n{info['desc']}\n\n## 歷史與故事\n{info['history']}\n\n## 特色\n{info['features']}\n\n## 基本資訊\n{info['info']}", content)

    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(new_content)
    print(f"Updated {name}")

def main():
    for fname in os.listdir(FEATURES_DIR):
        match = FILE_PATTERN.match(fname)
        if match:
            idx = match.group(1)
            name = match.group(2)
            filepath = os.path.join(FEATURES_DIR, fname)
            update_file(filepath, idx, name)

if __name__ == "__main__":
    main()
